<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="../static/logo.png">
    <title>{{ game['title'] }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/game_page.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/base.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

</head>
<body>
    <!-- Header -->
    {% include "header.html" %}
    
    <div class="content">
        <!-- Left: Cover & Info -->
        <div class="panel info-panel">
            <h1>{{ game['title'] }}
                <a href="/crawl/{{ game['title'] }}" class="edit-link"><i class="fa-solid fa-spider"></i></a>
            </h1>
            <img src="{{ url_for('static', filename=game['cover']) }}" alt="{{ game['title'] }} Cover" 
                onclick="showCover(this.src)" style="cursor: pointer; margin:5px" loading="lazy">
            
            {% if 'Release Date' in game %}
                <p><strong>Release Date:</strong> {{game['Release Date']}}</p>
            {% endif %}
            {% if 'Genres' in game %}
            <p><strong>Genres:</strong></p>
            <div class="widget-tabs" style="text-align: justify">
                {% for tag in game['Genres'][:5] %}
                    <span class="widget-tab">{{tag.title()}}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if 'similar_games' in game and game['similar_games']|length > 0 %}
                <p><strong>Similar Games:</strong></p>
                <div class="image-slider">
                {% for game in game['similar_games'] %}
                    <img src="{{ url_for('static', filename='Covers New/' + game['path'] + ' Cover.jpg') }}" 
                    class="redirect" data-url="/game/{{ game['title'] }}" alt="Similar Image">

                {% endfor %}
                </div>
            {% endif %}
        </div>

        <!-- Center: Tabbed Widgets -->
        <div style="width: 55%;">
            <div class="panel main-panel">
                <div class="widget-tabs-container">
                    <div class="widget-tabs" id="tabs-container">
                        {% set all_tabs = [] %}
                        {% for site in game['sites'] %}
                        {% set logo = site.lower() + '_logo.png' %}
                        {% set tab = {
                            "id": site,
                            "logo": logo,
                            "label": site.title(),
                            "is_active": loop.first
                        } %}
                        {% set _ = all_tabs.append(tab) %}
                        {% endfor %}
                        {% for site in ['giantbomb-raw', 'moby-raw', 'steam-raw', 'rawg-raw', 'wikipedia-raw'] %}
                        {% if site in game %}
                            {% set logo = site.split('-')[0].lower() + '_logo.png' %}
                            {% set tab = {
                            "id": site,
                            "logo": logo,
                            "label": site.title(),
                            "is_active": false
                            } %}
                            {% set _ = all_tabs.append(tab) %}
                        {% endif %}
                        {% endfor %}
                        {% for key in ['RAWG Achievements', 'Steam Achievements'] %}
                        {% if key in game %}
                            {% set logo = key.split(' ')[0].lower() + '_logo.png' %}
                            {% set tab = {
                            "id": key,
                            "logo": logo,
                            "label": key.split(' ')[0],
                            "is_active": false,
                            "extra_logo": "achievement.png"
                            } %}
                            {% set _ = all_tabs.append(tab) %}
                        {% endif %}
                        {% endfor %}
                        {% if 'Trophies' in game %}
                        {% set tab = {
                            "id": "Trophies",
                            "logo": "psn_logo.png",
                            "label": "Trophies",
                            "is_active": false,
                            "extra_logo": "achievement.png"
                        } %}
                        {% set _ = all_tabs.append(tab) %}
                        {% endif %}

                        {# Render first 5 tabs normally #}
                        {% for tab in all_tabs[:5] %}
                        <div class="widget-plus widget-tab{% if tab.is_active %} active{% endif %}" 
                            onclick="activateTab('{{ tab.id }}')">
                            <img src="{{ url_for('static', filename=tab.logo) }}" class="score-logo">
                            <span>{{ tab.label }}</span>
                            {% if tab.extra_logo %}
                            <img src="{{ url_for('static', filename=tab.extra_logo) }}" class="score-logo">
                            {% endif %}
                        </div>
                        {% endfor %}

                        {# "More" dropdown if > 5 #}
                        {% if all_tabs|length > 5 %}
                        <div class="widget-tab more-tab" onclick="toggleMoreMenu()">…</div>
                        <div class="more-menu hidden" id="more-menu">
                            {% for tab in all_tabs[5:] %}
                            <div class="widget-plus widget-tab" 
                                onclick="activateTab('{{ tab.id }}', true)">
                                <img src="{{ url_for('static', filename=tab.logo) }}" class="score-logo">
                                <span>{{ tab.label }}</span>
                                {% if tab.extra_logo %}
                                <img src="{{ url_for('static', filename=tab.extra_logo) }}" class="score-logo">
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>


                {% for site in game['sites'] %}
                <div id="{{ site }}" class="widget-content{% if loop.first %} active{% endif %}">
                    {% if site.lower() + '-url' in game %}
                        <a style="color: sandybrown" href="{{game[site.lower() + '-url']}}">{{game[site.lower() + '-url']}}</a>
                    {% endif %}
                    {% for text_elem in ['intro', 'description', 'summary', 'gameplay', 'synopsis', 'plot', 'reception'] %}
                        {% set elem = site.lower() + '-' + text_elem %}
                        {% if elem in game %}
                            <p ><strong style="color: sandybrown;">{{ text_elem.title() }}</strong></p>
                            <p style="text-align: justify;">{{ game[elem].replace('\n', '<br>').strip() | safe }}</p>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endfor %}

                <!-- Raw Content -->
                {% for site in ['giantbomb-raw', 'moby-raw', 'steam-raw', 'rawg-raw', 'wikipedia-raw'] %}
                    {% if site in game %}
                        <div id="{{ site }}" class="widget-content">
                            <div>
                                {{game[site]  | safe }}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                
                {% for key in ['RAWG Achievements', 'Steam Achievements'] %}
                    {% if key in game %}
                        <div id="{{key}}" class="widget-content">
                            <div class="achievements">
                                {% for achievement in game[key] %}
                                    <div class="achievement">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{ achievement['percent'].replace('%', '') }}%;"></div>
                                        </div>

                                        <div class="achievement-content">
                                            <img src="{{ achievement['image'] }}" 
                                                alt="{{ achievement['name'] }}" 
                                                class="achievement-icon">
                                            <div class="achievement-info">
                                            <span class="achievement-name">{{ achievement['name'] }}</span>
                                            <span class="achievement-percentage">{{ achievement['percent'].replace('%', '') }}%</span>
                                            <p class="achievement-text">{{ achievement['description'] }}</p>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                {% if 'Trophies' in game %}
                    <div id="Trophies" class="widget-content">
                        <div class="achievements">
                            {% for achievement in game['Trophies'] %}
                                <div class="achievement {% if not achievement.text %}achievement-special{% endif %}">
                                    {% if 'percentage-2' in achievement %}
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{ achievement['percentage-2'].replace('%', '') }}%;"></div>
                                        </div>
                                    {% endif %}
                                    <div class="achievement-content">
                                        <img src="{{ achievement['image'] }}" 
                                            alt="{{ achievement['title'] }}" 
                                            class="achievement-icon">
                                        <div class="achievement-info">
                                            <span class="achievement-name  {% if not achievement.text %}achievement-name-sp{% endif %}">{{ achievement['title'] }}</span>
                                            <span class="achievement-percentage">{{ achievement['percentage-2'] }}</span>
                                            <p class="achievement-text">{{ achievement['text'] }}</p>
                                        </div>
                                    </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

            </div>
            <div class="image-slider" id="image-slider">
            {% for img_url in game['gallery'] %}
                <img src="{{ url_for('static', filename=img_url) }}" alt="Gallery Image" onclick="showlightbox(this.src)" loading="lazy">
            {% endfor %}
            </div>
        </div>

        <!-- Right: Scores -->
        <div class="panel score-panel">
            <h3 style="color: sandybrown;">Information</h3>
            {% if 'scores' in game %}
                {% for sc in game['scores'] %}
                    <!--<p>{{sc}}: <span class="score-box" style="background-color: {{game['scores'][sc][1]}}">{{game['scores'][sc][0]}}</span></p>-->
                    <div class="score-row">
                        {% set logo = sc.split(' ')[0].lower() + '_logo.png' %}
                        <img src="{{ url_for('static', filename=logo) }}" alt="{{sc}} logo" class="score-logo">
                        <span class="score-label">{{sc}}</span>
                        <span class="score-box" style="background-color: {{ game['scores'][sc][1] }}">
                            {{game['scores'][sc][0]}}
                        </span>
                        </div>
                {% endfor %}
            {% endif %}
            
            {% if 'backloggd-split-rating' in game %}
                <div class="barplot-row">
                    <img src="{{ url_for('static', filename='backloggd_logo.png') }}" alt="{{sc}} logo" class="score-logo">
                    <span >Avg Rating: {{ game['scores'].get('Backloggd Rating', ['/'])[0] }}</span>
                </div>
                
                <div class="score-histogram">
                {% set max_count = game['backloggd-split-rating'].values() | max %}       
                {% for rating, rating_count in game['backloggd-split-rating'].items()  %}
                    {% set height = (rating_count / [max_count, 1] | max * 100) | round(0, 'ceil') %}
                    {% set height = [height, 1] | max %}
                    <div class="bar" style="height: {{ height }}%;" title="{{ rating }} ★ – {{ rating_count }} votes">
                    </div>
                {% endfor %}
                </div>
                <span>
                    0.5★
                </span>
                <span style="float:right">
                    5★
                </span>
            {% endif %}
        </div>

        <div class="lightbox-bg" id="coverbox">
            <img id="coverbox-img" src="" alt="Preview">
        </div>

        <div class="lightbox-bg" id="lightbox">
            <button class="lightbox-nav" id="lightbox-prev">&#10094;</button>
            <img id="lightbox-img" src="" alt="Preview">
            <button class="lightbox-nav" id="lightbox-next">&#10095;</button>
        </div>
    </div>

    <script>

        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const galleryImages = Array.from(document.querySelectorAll('#image-slider img'));
        let currentIndex = -1;

        function showlightbox(src) {
            currentIndex = galleryImages.findIndex(img => img.src === src);
            if (currentIndex >= 0) {
                lightboxImg.src = galleryImages[currentIndex].src;
                lightbox.style.display = 'flex';
            }
        }

        document.getElementById('lightbox-prev').onclick = () => {
            if (currentIndex > 0) {
                currentIndex--;
                lightboxImg.src = galleryImages[currentIndex].src;
            }
            else {
                currentIndex = galleryImages.length - 1;
                lightboxImg.src = galleryImages[currentIndex].src;
            }
        };

        document.getElementById('lightbox-next').onclick = () => {
            if (currentIndex < galleryImages.length - 1) {
                currentIndex++;
                lightboxImg.src = galleryImages[currentIndex].src;
            }
            else{
                currentIndex = 0;
                lightboxImg.src = galleryImages[currentIndex].src;
            }
        };

        lightbox.onclick = (e) => {
            // Close only if background is clicked (not image or buttons)
            if (e.target === lightbox) {
                lightbox.style.display = 'none';
                currentIndex = -1;
            }
        };

        document.addEventListener('keydown', (e) => {
            if (lightbox.style.display === 'flex') {
                if (e.key === 'ArrowLeft') document.getElementById('lightbox-prev').click();
                else if (e.key === 'ArrowRight') document.getElementById('lightbox-next').click();
                else if (e.key === 'Escape') lightbox.style.display = 'none';
            }
        });

        function showTab(id) {
            const tabs = document.querySelectorAll('.widget-tab');
            const contents = document.querySelectorAll('.widget-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            document.querySelector('.widget-tab[onclick*="' + id + '"]').classList.add('active');
            document.getElementById(id).classList.add('active');
        }


        function showCover(src) 
        {
            const lightbox = document.getElementById('coverbox');
            const img = document.getElementById('coverbox-img');
            img.src = src;
            lightbox.style.display = 'flex';
        }

        document.getElementById('coverbox').onclick = () => 
        {
            document.getElementById('coverbox').style.display = 'none';
        }
        document.querySelectorAll(".redirect").forEach(img => {
            img.style.cursor = "pointer";
            img.addEventListener("click", () => {
            window.location.href = img.dataset.url;
            });
        });

        function toggleMoreMenu() {
            document.getElementById("more-menu").classList.toggle("hidden");
            }

            function activateTab(id, fromMenu=false) {
            // remove active class from all
            document.querySelectorAll(".widget-tab").forEach(tab => tab.classList.remove("active"));

            // add to clicked
            const tabEl = [...document.querySelectorAll(".widget-tab")]
                .find(el => el.getAttribute("onclick")?.includes(id));
            if (tabEl) tabEl.classList.add("active");

            // close dropdown if from menu
            if (fromMenu) {
                document.getElementById("more-menu").classList.add("hidden");
            }

            // Your existing logic to showTab content
            showTab(id);
            }
    </script>
    <script src="{{ url_for('static', filename='scripts/base.js') }}"></script>
</body>
</html>
